<html>
<head>
    <meta charset="utf-8"/>
    <title>地图页面</title>
    <link rel="stylesheet" typw="text/css" href="css/ol.css"/>
    <link rel="stylesheet" type="text/css" href="css/fonticon/iconfont.css">
    <link rel="stylesheet" type="text/css" href="css/popup.css">

    <style type="text/css">
        html {
            overflow: hidden;
        }
        body {
            background-color: #808080
        }
        p, span {
            margin-left: 2px;
            font-family: 微软雅黑;
            font-size: 12px;
            color: #ffffff
        }
        #map {
            width: 100%;
            height: 95%;
        }

    </style>
</head>

<body>
<div id="map">
</div>
<select id="layer-select">
    <option value="矢量图1" selected>矢量图1</option>
    <option value="矢量图2" >矢量图2</option>
</select>



</body>

<script type="text/javascript" src="js/public/ol.js"></script>
<script type="text/javascript" src="js/public/jquery-1.12.3.min.js"></script>
<script type="text/javascript" >


    /**
     * MapServer 对象
     */
    var MapServerParameter = function(){
    };

    /**
     * MapServer pjson 参数对象
     * @type {{
     * layerUrl: string ,
     * layerName: string ,
     * center: Array,
     * wkid: string,
     * fullExtent: Array,
     * initialExtent: Array,
     * projection: {},
     * tileSize: Array,
     * origin: Array,
     * resolutions: Array
     * }}
     */
    MapServerParameter.prototype = {
        layerUrl:'',
        layerName:"",
        center : [],
        wkid:"4326",
        fullExtent: [],
        initialExtent :[],
        projection:{},
        tileSize:[],
        origin:[],
        resolutions:[]
    };

    //定义hdmap API对象
    var HdMap = function() {
    };
    //地图对象
    HdMap.prototype = {
        olMap:null,

        layers:[],

        olVectorSource: new ol.source.Vector({
            features:[]
        }),

        olVectorLayer :new ol.layer.Vector({
            layerName: "default",
            //style:this.autoStyle,
            source: new ol.source.Vector({
                wrapX: false
            })
        }),

        tileLayer:function(paramater){

            var urlTemplate = paramater.layerUrl + "/tile/{z}/{y}/{x}";

            var tileGrid = new ol.tilegrid.TileGrid({
                tileSize: paramater.tileSize,
                origin: paramater.origin,
                extent: paramater.fullExtent,
                resolutions: paramater.resolutions
            });

            var tileSource = new ol.source.XYZ({
                url: urlTemplate,
                //urls:[],
                //attributions:{},
                cacheSize: 2048,
                //crossOrigin:"",
                //logo: "恒达时讯",
                opaque: false, //不透明的
                projection: paramater.projection,
                //minZoom: 1,
                //maxZoom: 12,
                wrapX: true,//是否水平包裹世界
                tileGrid: tileGrid,
                tileLoadFunction: function (imageTile, src) {
                    imageTile.getImage().src = src;
                    console.log("123");
                },
                tileUrlFunction: function (tileCoord) {
                    var url = urlTemplate.replace('{z}', (tileCoord[0]).toString())
                            .replace('{x}', tileCoord[1].toString())
                            .replace('{y}', (-tileCoord[2] - 1).toString());
                    return url;
                }
            });

            var mapLayer = new ol.layer.Tile({
                opacity: 1, //透明度 (0-1)
                preload: 0, //预加载
                //map:{}, //图层叠加
                visible: true,
                extent: paramater.fullExtent,
                layerName:paramater.layerName,
                useInterimTilesOnError: true,//使用临时切片
                source: tileSource
            });
            return mapLayer;
        },
        //地图初始化
        init:function(mapServerParameter) {

            var mapLayer = this.tileLayer(mapServerParameter);

            var mapView =  new ol.View({
                zoom: 0,
                projection: mapServerParameter.projection,
                extent: mapServerParameter.fullExtent,    //分层渲染的边界范围
                center: ol.proj.fromLonLat(mapServerParameter.center, ol.proj.get("EPSG:"+mapServerParameter.wkid)),
                maxResolution: mapServerParameter.resolutions[0],//最大分辨率
                minResolution: mapServerParameter.resolutions[mapServerParameter.resolutions.length - 1]//最小分辨率
            });

            this.olMap = new ol.Map({
                target: 'map',
                controls:  ol.control.defaults().extend([
                    new ol.control.FullScreen()
                ]),
                //pixelRatio: {},
                //interactions:{},
                // 键盘事件
                //keyboardEventTarget:{},
                layers: [mapLayer],
                loadTilesWhileAnimating: true,
                loadTilesWhileInteracting: true,
                //logo: "恒达时讯",
                //overlays:{},
                //renderer:{},
                view: mapView
            });

        },
        zoom:function (level) {
            this.olMap.getView().setZoom(level);
        },
        addMultiPoint:function (features) {
            if(features == undefined || features == null || features.length < 1){
                return;
            }
            var olFeature;
            for(var i = 0 ,len = features.length ;i < len ;i++){
                var format = new ol.format.WKT();
                var feature = format.readGeometry(features[i].geometry);
                //为什莫设置style 无效
                var style = new ol.style.Style({
                    image: new ol.style.Icon({
                        anchor: [0.5, 50],
                        rotation: 0, //图片旋转
                        anchorXUnits: 'fraction',
                        anchorYUnits: 'pixels',
                        opacity: 0.75,
                        src: "icon/marker.png"
                    }),
                    text: new ol.style.Text({
                        text: (i+1)+"",
                        offsetX: 0.5,
                        offsetY: -40,
                        fill: new ol.style.Fill({
                            color: "#FFFFFF"
                        })
                    })
                });
                olFeature = new ol.Feature({
                    id:features[i].attributes.ID,
                    name: '我标的点',
                    //style:style,//应用单个样式
                    geometry:  feature,
                    labelPoint:feature
                });
                olFeature.setStyle(style);
                this.olVectorLayer.getSource().addFeature(olFeature);
            }
            //this.olVectorLayer.setStyle(this.olStyle.Point);//批量样式应用
            this.olMap.addLayer(this.olVectorLayer);
        },
        addMultiLine:function (features) {
            if(features == undefined || features == null || features.length < 1){
                return;
            }

            var lineStyle = new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: '#0000EE',
                    width: 4
                })
            });
            var olFeature;
            for(var i = 0 ,len = features.length ;i < len ;i++){
                var format = new ol.format.WKT();
                //var feature = format.readGeometry(features[i].geometry);
                var feature = format.readFeature(features[i].geometry, {
                    dataProjection: 'EPSG:4326',
                    featureProjection: 'EPSG:3857'
                });
                /*olFeature = new ol.Feature({
                    //id:features[i].attributes.ID,
                    name: '我标的线',
                    //style: this.olStyle.LineString,//单个样式
                    geometry:  feature
                    //labelPoint:feature
                });
                olFeature.setStyle(lineStyle);
                this.olVectorLayer.getSource().addFeature(olFeature);*/
                this.olVectorLayer.getSource().addFeature(feature);
            }
            //this.olVectorLayer.setStyle(this.olStyle.LineString);//批量样式应用
            this.olMap.addLayer(this.olVectorLayer);
        },
        autoStyle: function(feature) {
            return this.olStyle[feature.getGeometry().getType()];
        },
        olStyle:{
            'Point': new ol.style.Style({
                image: new ol.style.Icon({
                        anchor: [0.5, 50],
                        rotation: 0, //图片旋转
                        anchorXUnits: 'fraction',
                        anchorYUnits: 'pixels',
                        opacity: 0.75,
                        src: "icon/marker.png"
                })
            }),
            'LineString': new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: 'green',
                    width: 1
                })
            }),
            'MultiLineString': new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: 'green',
                    width: 1
                })
            }),
            'MultiPoint': new ol.style.Style({
                image: new ol.style.Circle({
                    radius: 5,
                    fill: null,
                    stroke: new ol.style.Stroke({color: 'red', width: 1})
                })
            }),
            'MultiPolygon': new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: 'yellow',
                    width: 1
                }),
                fill: new ol.style.Fill({
                    color: 'rgba(255, 255, 0, 0.1)'
                })
            }),
            'Polygon': new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: 'blue',
                    lineDash: [4],
                    width: 3
                }),
                fill: new ol.style.Fill({
                    color: 'rgba(0, 0, 255, 0.1)'
                })
            }),
            'GeometryCollection': new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: 'magenta',
                    width: 2
                }),
                fill: new ol.style.Fill({
                    color: 'magenta'
                }),
                image: new ol.style.Circle({
                    radius: 10,
                    fill: null,
                    stroke: new ol.style.Stroke({
                        color: 'magenta'
                    })
                })
            }),
            'Circle': new ol.style.Style({
                stroke: new ol.style.Stroke({
                    color: 'red',
                    width: 2
                }),
                fill: new ol.style.Fill({
                    color: 'rgba(255,0,0,0.2)'
                })
            })
        },
    };

    //Demo 应用
    var hdmap = new HdMap();

    var mapConfig = {
        target:"map",
        center : [115.657373, 28.667832],
        layerName:"矢量地图",
        layerUrl:"http://171.34.40.68:6080/arcgis/rest/services/JXMAP_2016/MapServer"
    };

    var parameter = new MapServerParameter();
    $(document).ready(function () {
        //服务参数拾取
        $.ajax({
            url: mapConfig.layerUrl+"/?f=pjson",
            dataType: 'jsonp',
            async:false,
            success: function (data) {
                if (data.error) {
                    console.error(data.error.message + '\n' +data.error.details.join('\n'));
                    return;
                };
                parameter.layerUrl = mapConfig.layerUrl;
                parameter.center = mapConfig.center;
                parameter.wkid = data.spatialReference.wkid;
                parameter.fullExtent = [data.fullExtent.xmin, data.fullExtent.ymin, data.fullExtent.xmax, data.fullExtent.ymax];
                parameter.origin = [data.tileInfo.origin.x, data.tileInfo.origin.y];
                parameter.tileSize = [data.tileInfo.cols,data.tileInfo.rows];
                parameter.projection = ol.proj.get("EPSG:" + data.spatialReference.wkid);
                var len = data.tileInfo.lods.length;
                var resolutions = [];
                for (var i = 0; i < len; i++) {
                    resolutions.push(data.tileInfo.lods[i].resolution);
                }
                parameter.resolutions = resolutions;
                var mapLayer = hdmap.tileLayer(parameter);
                hdmap.init(parameter);
                hdmap.olMap.addLayer(mapLayer);
                imageTileLayer();
/*
                $.ajax({
                    url: "json/points.json",
                    dataType: 'json',
                    success: function (data) {
                        hdmap.addMultiPoint(data.features);
                    }
                });*/

                $.ajax({
                    url: "json/lines.json",
                    dataType: 'json',
                    success: function (data) {
                        hdmap.addMultiLine(data.features);
                    }
                });
            }
        });
    });

    var styles = [
        '矢量图1',
        '矢量图2'
    ];

    var select = document.getElementById('layer-select');
    function onChange() {
        var style = select.value;
        for (var i = 0, ii = hdmap.layers.length; i < ii; ++i) {
            if(style == styles[i]){
                hdmap.init(parameter2);
                hdmap.olMap.setVisible(true)
                var view = hdmap.olMap.getView();
                view.setCenter(mapConfig2.center);
            }else{
                hdmap.olMap.setVisible(true)
            }

        }
    }
    select.addEventListener('change', onChange);
    onChange()

    var mapConfig2 = {
        center : [115.657373, 28.667832],
        layerName:"影像地图",
        layerUrl:"http://211.101.37.251:6080/arcgis/rest/services/jxgxptmap_2015ncyw/MapServer"
    };

    /********加载影像地图*******/
    var parameter2 = new MapServerParameter();
    function imageTileLayer(){
        $.ajax({
            url: mapConfig2.layerUrl+"/?f=pjson",
            dataType: 'jsonp',
            async:false,
            success: function (data) {
                if (data.error) {
                    console.error(data.error.message + '\n' +data.error.details.join('\n'));
                    return;
                };
                parameter2 = new MapServerParameter();
                parameter2.layerUrl = mapConfig2.layerUrl;
                parameter2.center = mapConfig2.center;
                parameter2.wkid = data.spatialReference.wkid;
                parameter2.fullExtent = [data.fullExtent.xmin, data.fullExtent.ymin, data.fullExtent.xmax, data.fullExtent.ymax];
                parameter2.origin = [data.tileInfo.origin.x, data.tileInfo.origin.y];
                parameter2.tileSize = [data.tileInfo.cols,data.tileInfo.rows];
                parameter2.projection = ol.proj.get("EPSG:" + data.spatialReference.wkid);
                var len = data.tileInfo.lods.length;
                var resolutions = [];
                for (var i = 0; i < len; i++) {
                    resolutions.push(data.tileInfo.lods[i].resolution);
                }
                parameter2.resolutions = resolutions;
                var mapLayer = hdmap.tileLayer(parameter2);
                mapLayer.setVisible(false);
                hdmap.olMap.addLayer(mapLayer);
            }
        });
    }
</script>
</html>