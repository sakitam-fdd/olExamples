<html>
	<head>
		<meta charset="utf-8" />
		<title>PPVision 控件测试页面</title>	

		<style type="text/css">
			html
			{
			   overflow: hidden;
			}
			body
			{
				background-color: #808080	
			}
			p,span
			{	
				margin-left:2px; 
				font-family:微软雅黑;
				font-size:12px;
				color:#ffffff
			}
			img{height:400px;width:auto;}
			.button
			{
				width:70px;
				height:20px;
				border:0;
				font-family:微软雅黑;
				font-size:12px;
			} 
			#mask
			{
				position:fixed;
				left:0px;
				top:0px;
				z-index:100;				
			}
			#toolbar
			{
				left:0px;
				top:0px;
				z-index:100;
			}
			#PPVision
			{
				z-index:100;
				width:50%;
				height:80%;	
				float:left;
			}
			#map
			{
				width:50%;
				height:80%;	
				float:left;
			}
			#history
			{
				left:20%;
				top:25%;
				width:60%;
				height:480;	
				position:absolute;
				background-color: #FFFFFF;
				z-index:9999;
			}
			/*
			#history {
				position:absolute;
				top:50%;
				left:50%;
				margin:-100px 0 0 -100px;
				width:200px;
				height:200px;
				border:1px solid red;
				z-index:1000;
			} 
			*/
		</style>
	</head>

	<body>
		<object id="PPVision" classid="CLSID:C2DF135F-24D6-49F7-820A-6CD1B264A60F">
		</object>
		<div id="map"></div>

		<div id="toolbar">
			<div style="margin:5px;">
				<span>编辑</span>
				<input class="button" type="button" id="samplePhoto" value="摄影测量采样">
				<input class="button" type="button" id="sampleGround" value="地面采样">
				<input class="button" type="button" id="popHtml" value="弹出HTML">
				<input class="button" type="button" id="lookAt" value="LookAt">
				<input class="button" type="button" id="play" value="play">
				<input class="button" type="button" id="stop" value="stop">
			</div>
			<div style="margin:5px;">
				<span>对象枚举</span>
				<input class="button" type="button" id="addLayer" value="添加图层">
				<input class="button" type="button" id="removeLayer" value="删除图层">
				<input class="button" type="button" id="addFeature" value="添加对象">
				<input class="button" type="button" id="removeFeature" value="删除对象">
				<input class="button" type="button" id="getFeature" value="获取对象定义">
			</div>
		</div>
		<div style="width:50%;margin-top:20px;">
			<div><span>当前位置：</span><span id="eye">0</span></div>
			<div><span>log：</span><span id="log"></span></div>		
			<div><span>out：</span><span id="out"></span></div>		
		</div>
	</body>


	<link rel="stylesheet" href="leaflet-1.1/leaflet.css" />
	<script type="text/javascript" src="leaflet-1.1/leaflet.js"></script>
	<script type="text/javascript" src="leaflet-1.1/leaflet.ChineseTmsProviders.js"></script>
	<script type="text/javascript" src="leaflet-1.1/leaflet.orientedmarker.js"></script>
	<script type="text/javascript" src="jquery-1.12.3.min.js"></script>
	<script language="javascript">
		

		// 图像序列类型
		var dt_null			=0;
		var dt_trimble		=1;
		var dt_imms			=2;
		var dt_imajbox		=3;
		var dt_streetview	=4;
		var dt_topcon		=5;
		var dt_riegl		=6;
		var dt_optech		=7;


		// 采样模式类型
		var id_sample_cloud                 =50401;
		var id_sample_photo                 =50402;
		var id_sample_3d                    =50403;
		var id_sample_plane                 =50404;
		var id_sample_ground                =50405;
		var id_sample_depth                 =50406;


		function onFrame(id)
		{
			var ret = PPVision.locateByID(dt_imajbox, id);//42670 49466 11330
			log_locate(ret);
			$("#history").remove();
		}

		function initPPVision()
		{
			//PPVision.setServer("http://192.168.11.227/PPVisionServer.asmx");
			//PPVision.setServer("http://123.57.77.213:8090/PPVisionServer.asmx");
			var ret = PPVision.setServer("http://211.101.37.253:8099/PPVisionServer.asmx");

			//var ret = PPVision.locateByID(dt_imajbox, 20903);//42670 49466 11330 11480
			var ret = PPVision.locate(dt_imajbox, 115.657373,28.667832, 0.0);//php：20903
			log_locate(ret);
		}
		function log_locate(ret)
		{
			switch (ret)
			{
			case 1:	$("#log").text("locate: busy");	break;
			case 2:	$("#log").text("locate: type invalidate");	break;
			case 3:	$("#log").text("locate: null data");	break;
			case 4:	$("#log").text("locate: change srs, please save your feature");	break;
			case 5:	$("#log").text("locate: no license");	break;			
			}
		}

		function locate()
		{

		}



		///
		/// 按钮事件
		///
		$("#samplePhoto").click(function()
		{
			PPVision.setSampleMode(id_sample_photo);
		});
		$("#sampleGround").click(function()
		{
			PPVision.setSampleMode(id_sample_ground);
		});
		$("#popHtml").click(function()
		{
			PPVision.popHtml('www.baidu.com');
		});
		$("#lookAt").click(function()
		{
			PPVision.lookAt(0,0,0);
		});
		$("#play").click(function()
		{
			PPVision.play();
		});
		$("#stop").click(function()
		{
			PPVision.stop();
		});



		$("#addLayer").click(function()
		{	
			var layer_point = {
				"name":"Lamp Pole",
				"type":"Point",//Point, Line, Polygon 三种类型，并非强约束
				"color":"0,0,255,255",//RGBA or RGB
				"size":15,
				"icon":{
					"size":[48,48],
					"offset":[0,24],
					"url":"http://localhost/icon/019-marker.png"
				}
			};
			var json = JSON.stringify(layer_point);
			hlay_point = PPVision.addLayer(json);


			var layer_line = {
				"name":"test",
				"type":"Line",//Point, Line, Polygon 三种类型，并非强约束
				"color":"0,0,255,255",//RGBA or RGB
				"size":2
			};
			var json = JSON.stringify(layer_line);
			hlay_line = PPVision.addLayer(json);

			var layer_poly = {
				"name":"test_poly",
				"type":"Polygon",//Point, Line, Polygon 三种类型，并非强约束
				"color":"0,255,0,128",//RGBA or RGB
				"size":2
			};
			var json = JSON.stringify(layer_poly);
			hlay_poly = PPVision.addLayer(json);
		});
		$("#removeLayer").click(function()
		{	
			PPVision.removeLayer(hlay_point);	hlay_point = 0;
			PPVision.removeLayer(hlay_line);	hlay_line = 0;
			PPVision.removeLayer(hlay_poly);	hlay_poly = 0;			
		});
		// 添加一个点，到新建的图层
		$("#addFeature").click(function()
		{	
			var fe_point = {
				"type":"Feature",
				"properties":{
					"fid":1234,
					"name":"灯杆",
					/*
					"color":"0,255,255,255",//RGBA or RGB
					"size":25,
					"icon":{
						"size":[32,32],
						"offset":[0,16],
						"url":"http://localhost/icon/019-marker.png"
					}
					*/
				},
				"geometry":{
					"type":"Point",
					"coordinates":[103.7618144853319,36.08614306284845,1481.648249594895]
				}
			};
			var json = JSON.stringify(fe_point);
			hfe_point = PPVision.addFeature(hlay_point, json);	

			var fe_line = {
				"type":"Feature",
				"properties":{
					"fid":1235,
					"name":"灯杆线"
				},
				"geometry":{
					"type":"LineString",
					"coordinates":			
							[
							[103.7618144853319,36.08614306284845,1481.648249594895],
							[103.7618208079553,36.08615258697326,1488.536865634426],
							[103.7618001531699,36.08614508641016,1490.143430821786]
							]
				}

			};
			var json = JSON.stringify(fe_line);
			hfe_line = PPVision.addFeature(hlay_line, json);

			var fe_poly = {
				"type":"Feature",
				"properties":{
					"fid":1236,
					"name":"地面斑",
					"to_ground":true
				},
				"geometry":{
					"type":"Polygon",
					"coordinates":
					
							[[[103.7617351272638,36.08608582409791,-1.5],
							[103.76173257549,36.08612553371825,-1.5],
							[103.7617494401201,36.08611998333379,-1.5],
							[103.7617639558404,36.08609277851573,-1.5]]]

					/*
							[[[103.7617351272638,36.08608582409791,1480.280999952316],
							[103.76173257549,36.08612553371825,1480.280999952316],
							[103.7617494401201,36.08611998333379,1480.280999952316],
							[103.7617639558404,36.08609277851573,1480.280999952316]]]

					*/
				}
			};
			var json = JSON.stringify(fe_poly);
			hfe_poly = PPVision.addFeature(hlay_poly, json);				
			
		});
		// 删除刚才新建的对象
		$("#removeFeature").click(function()
		{	
			PPVision.removeFeature(hfe_point);	hfe_point = 0;
			PPVision.removeFeature(hfe_line);	hfe_line = 0;
			//PPVision.removeFeature(hfe_poly);	hfe_poly = 0;

			hfe = PPVision.findFeatureByID(1236);
			PPVision.removeFeature(hfe);

		});
		// 获取刚才新建的对象定义
		$("#getFeature").click(function()
		{	
			var def=PPVision.getFeature(hfe);				

			$("#log").text("<xmp>"+def+"</xmp>");
		});

		///
		/// PPVision Events
		///
		function PPVision::onInit(){
			//响应控件初始化
			//init();
			//var node = document.getElementById("log");
			//node.innerHTML = "PPVision init";
		}
		function PPVision::onTool(cid){
			//响应设置当前工具
			$("#log").text("tool changed: " + cid);
		}
		function PPVision::onSampleMode(mode){
			//响应设置当前采样模式
			$("#log").text("sample mode changed: "+mode);
		}
		function PPVision::onFeatureCreate(def){
			//响应要素创建成功
			$("#log").text(def);			

			//
			var fe = JSON.parse(def);//浏览器内置对象
			layerFeature.addData(fe);//添加到gis窗口

			//添加到PPVision，这样设计是为了让用户有机会编辑它的id，以及选择图层
			//图层要提前准备好
			var type = fe["geometry"]["type"];
			if (type=="Point")
			{
				PPVision.addFeature(hlay_point, def);
			}
			else if (type=="LineString")
			{
				PPVision.addFeature(hlay_line, def);
			}
			else if (type=="Polygon")
			{
				PPVision.addFeature(hlay_poly, def);
			}
		}
		function PPVision::onFeatureSelect(handle, id){
			//响应要素选中
			$("#log").text("select: " + id);
		}
		function PPVision::onFeatureRemove(handle, id){
			//响应要素删除
			$("#log").text("remove: " + id);
		}
		function PPVision::onHistory(id){
			//响应历史对比
			//$("body").append("<iframe id=\"history\" src=\"file://c:/ppvision/cache/history.html\"></iframe>");
			/*
			var id=11330;
			var tol = 50;
			var angle = 15;
			$.get("php/history.php",{ id: id, tol:tol, angle:angle }, function(ret){
				if (ret=="")
					return;
				$("body").append(ret);
			});
			*/
		}
		function PPVision::onMeasure(def){
			//响应测量位置坐标
			$("#log").text(def);
		}
		function PPVision::onPosition(lon,lat,alt){
			//响应视点移动
			$("#eye").text("(" + lon + "," + lat + "," +alt + ")");

			//定位地图
			if (typeof(mymap)!="undefined")
			{
				g_coord = L.latLng(lat,lon);
				mymap.panTo(g_coord);
				eyeMarker.setLatLng(g_coord);
			}
		}
		function PPVision::onHeading(heading,fovx){
			//响应视角改变
			$("#eye").text("heading: " + heading + ", fov: " + fovx);

			//旋转视点
			if (typeof(eyeMarker)!="undefined" && typeof(g_coord)!="undefined")
			{
				eyeMarker.setAngle(heading);
			}
		}	
		function PPVision::onFrame(fid){
			//响应照片改变
			$("#log").text("frame changed: " + fid);		   
		}		
		function PPVision::onOut(str){
			//响应控件内部输出信息
			$("#out").text(str);		   
		}
		
	</script>	
	

	<script type="text/javascript">

		layerTrain = L.layerGroup();
		layerFeature = L.geoJson();
		
		var eyeIcon = L.icon({
			iconUrl: 'icon/eye.png',
			//iconRetinaUrl: 'my-icon@2x.png',
			iconSize: [64, 64],
			iconAnchor: [32, 54],
			//popupAnchor: [-3, -76],
			//shadowUrl: 'my-icon-shadow.png',
			//shadowRetinaUrl: 'my-icon-shadow@2x.png',
			//shadowSize: [68, 95],
			//shadowAnchor: [22, 94]
		});
		var frameIcon = L.icon({
			iconUrl: 'icon/bullet-blue.png',
			//iconRetinaUrl: 'my-icon@2x.png',
			iconSize: [6, 6],
			iconAnchor: [3, 3],
			//popupAnchor: [-3, -76],
			//shadowUrl: 'my-icon-shadow.png',
			//shadowRetinaUrl: 'my-icon-shadow@2x.png',
			//shadowSize: [68, 95],
			//shadowAnchor: [22, 94]
		});

		eyeMarker = L.orientedMarker([50.00116083, 8.65103859], {icon: eyeIcon});
		//eyeMarker = L.marker([50.00116083, 8.65103859], {icon: eyeIcon});


		var popup = L.popup();

		
		var myMarker = L.Marker.extend({
			id:-1,
		});
		function plotResult(result)
		{
			layerTrain.clearLayers();

			if (result=="")
				return;

			//var res_v = $.parseJSON(result);//jQuery
			var res_v = JSON.parse(result);//浏览器内置对象
			for(var i = 0; i < res_v.length; i++){

				var item = res_v[i];
				var marker = new myMarker([item.lat, item.lon], {icon: frameIcon});
				marker.id = item.id;
				layerTrain.addLayer(marker);
				marker.on("click", function(e){
					var ret = PPVision.locateByID(dt_imajbox, this.id);
					log_locate(ret);

				});
			}
			
		}

		$(document).ready(function()
		{
			mymap = L.map('map').setView([115.92466595234826, 27.428038204473552], 13);
			L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
				maxZoom: 20,
				attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',
				id: 'streets'
			}).addTo(mymap);

			layerTrain.addTo(mymap);
			layerFeature.addTo(mymap);

			eyeMarker.addTo(mymap);

			mymap.on('click', function(e) {
				var x = e.latlng.lng;
				var y = e.latlng.lat;
				var ret = PPVision.locate(dt_imajbox, x, y, 0);
				log_locate(ret);

				popup
					.setLatLng(e.latlng)
					.setContent(e.latlng.toString())
					.openOn(mymap);
			});


			mymap.on("moveend", function(obj){	

				var bound = mymap.getBounds();
				var zoom = mymap.getZoom();
				var x1 = bound.getWest();
				var y1 = bound.getSouth();
				var x2 = bound.getEast();
				var y2 = bound.getNorth();
				/*
				*/
				$.get("php/redraw.php",{ x1: x1, y1: y1, x2: x2, y2: y2, zoom: zoom }, function(ret){
					plotResult(ret);
				});

			});


			// 最后初始化ocx，然后定位到某一帧
			initPPVision();


		
		});//$(document).ready(function(){



	</script>

</html>
